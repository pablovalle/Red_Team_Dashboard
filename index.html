<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      body { 
        margin: 0; 
        padding: 20px; 
        font-family: Arial, sans-serif;
        background: #f8f9fa;
      }
      .container { 
        max-width: 1400px; 
        margin: 0 auto; 
      }

      .ranking-box h2 {
        font-weight: 800;  /* Made bolder */
      }

      .metrics-container { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 25px; 
        margin-bottom: 30px;
      }
      .metric-box { 
        background: white;
        padding: 25px; 
        border-radius: 12px; 
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        border: 1px solid rgba(0,0,0,0.1);
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .metric-box:hover {
        transform: translateY(-5px);
      }
      .metric-box h2 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 2em;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .counter {
        font-size: 3.5em;
        font-weight: bold;
        margin: 10px 0;
      }
      .metric-icon {
        font-size: 2em;
        margin-bottom: 15px;
      }
      .pass-box { 
        background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        border-left: 5px solid #28a745;
      }
      .pass-box .counter { color: #28a745; }
      
      .fail-box { 
        background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
        border-left: 5px solid #dc3545;
      }
      .fail-box .counter { color: #dc3545; }
      
      .ranking-box { 
        background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        border-left: 5px solid #ffc107;
      }
      .ranking-box .counter { color: #ffc107; }

      /* NUEVOS estilos para las barras horizontales */
      .metric-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .metric-label {
        width: 60px; 
        text-align: right;
        margin-right: 10px;
        font-weight: bold;
      }
      .progress-bar {
        flex: 1;
        background-color: #eee;
        border-radius: 4px;
        height: 12px;
        position: relative;
        overflow: hidden;
      }
      .progress {
        height: 100%;
        border-radius: 4px;
      }
      .progress-pass {
        background-color: #28a745; /* Verde */
      }
      .progress-fail {
        background-color: #dc3545; /* Rojo */
      }

      .charts-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 20px 0;
      }
      
      .chart-wrapper {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: 400px;
      }
      
      .chart-title {
        margin: 0 0 10px 0;
        font-size: 1.1em;
        color: #333;
      }
      
      canvas {
        max-height: 350px !important;
      }
      
      table { 
        width: 100%; 
        margin: 15px 0; 
        border-collapse: collapse; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      
      th, td { 
        padding: 12px; 
        border: 1px solid #eee;
        text-align: right;
      }
      .td2{
        text-align: left;
      }
      
      th { 
        background: #f8f9fa; 
        font-weight: 600;
        color: #333;
        text-align: center;
      }
      
      tr:nth-child(even) { background: #f9f9f9; }
      tr:hover { background: #f5f5f5; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Red Teaming Dashboard</h1>

      <div class="metrics-container">
        <!-- Caja 1: Total PASS -->
        <div class="metric-box pass-box">
          <h2>Total PASS <div class="metric-icon">✓</div></h2>
          <div id="totalPass" class="counter">0</div>
        </div>

        <!-- Caja 2: Total FAIL -->
        <div class="metric-box fail-box">
          <h2>Total FAIL <div class="metric-icon">✗</div></h2>
          <div id="totalFail" class="counter">0</div>
        </div>

        <!-- Caja 3: Sustituimos Top 3 Users por las barras de porcentaje -->
        <div class="metric-box ranking-box">
          <h2>Global Results</h2>
          <!-- Barra de PASS -->
          <div class="metric-row">
            <span class="metric-label" id="passLabel">PASS: 0%</span>
            <div class="progress-bar">
              <div class="progress progress-pass" id="passBar" style="width: 0%;"></div>
            </div>
          </div>
          <!-- Barra de FAIL -->
          <div class="metric-row">
            <span class="metric-label" id="failLabel">FAIL: 0%</span>
            <div class="progress-bar">
              <div class="progress progress-fail" id="failBar" style="width: 0%;"></div>
            </div>
          </div>
        </div>
      </div>

      <h2>Stats for each User</h2>
      <table id="userClassification">
        <thead>
          <tr>
            <th>User</th>
            <th>PASS</th>
            <th>FAIL Low</th>
            <th>FAIL Medium</th>
            <th>FAIL High</th>
            <th>FAIL Critical</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="charts-row">
        
        <div class="chart-wrapper">
          <h3 class="chart-title">PASS/FAIL for User</h3>
          <canvas id="userPassFailChart"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3 class="chart-title">Tests for each Model and User</h3>
          <canvas id="userModelChart"></canvas>
        </div>
      </div>

      <div class="charts-row">
        
        <div class="chart-wrapper">
          <h3 class="chart-title">Safety Categories</h3>
          <canvas id="categoriesChart"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3 class="chart-title">Languages</h3>
          <canvas id="LanguageScoreChart"></canvas>
        </div>
      </div>
    </div>

    <script>
      let charts = {};
      const MODEL_COLORS = {
        'chatgpt': '#00A67E', // ChatGPT green
        'gpt4': '#4A90E2',    // Blue
        'claude': '#7B61FF',  // Claude purple
        'gemini': '#1EA362',  // Gemini green
        'llama': '#FF6B6B',   // Red
        'mistral': '#FFB347', // Orange
        'default': '#999999'  // Gray for any other model
      };
      const LANGUAGE_COLORS = {
        'spanish': '#00A67E', // ChatGPT green
        'chinese': '#4A90E2',    // Blue
        'english': '#7B61FF',  // Claude purple
        'spanish': '#1EA362' // Gemini green
      };
      
      function getFailLevel(notes) {
        if (!notes) return 'low';
        notes = notes.toLowerCase();
        if (notes.includes('critical')) return 'critical';
        if (notes.includes('high')) return 'high';
        if (notes.includes('medium')) return 'medium';
        return 'low';
      }

      function getFailPoints(level) {
        const points = {
          low: 1,
          medium: 2,
          high: 3,
          critical: 4
        };
        return points[level] || 1;
      }

      function processData(data) {
        const result = {
          totalPass: 0,
          totalFail: 0,
          users: {},
          categories: {},
          models: {},
          languages: {}
        };

        data.forEach(row => {
          if(row.length < 8) return;

          const user = row[1];
          const model = row[2];
          const lang= row[3]
          const category = row[4];
          const resultStr = row[6].toLowerCase();
          const notes = row[7];
          const failLevel = getFailLevel(notes);

          // Inicializar user
          if(!result.users[user]) {
            result.users[user] = {
              pass: 0,
              failLow: 0,
              failMedium: 0,
              failHigh: 0,
              failCritical: 0,
              score: 0,
              models: {}
            };
          }

          // Inicializar categoría
          if(!result.categories[category]) {
            result.categories[category] = { pass: 0, fail: 0 };
          }
          if(!result.languages[lang]){
            result.languages[lang]= { pass: 0, fail: 0 };
          }
          // Inicializar modelo para el user
          if(!result.users[user].models[model]) {
            result.users[user].models[model] = 0;
          }
          result.users[user].models[model]++;

          if(resultStr === 'pass') {
            result.totalPass++;
            result.users[user].pass++;
            result.users[user].score += 1;
            result.categories[category].pass++;
            result.languages[lang].pass++;
          } else if (resultStr === 'fail') {
            result.totalFail++;
            result.users[user][`fail${failLevel.charAt(0).toUpperCase() + failLevel.slice(1)}`]++;
            result.users[user].score += getFailPoints(failLevel);
            result.categories[category].fail++;
            result.languages[lang].fail++;
          }
        });

        return result;
      }

      function updateUI({ totalPass, totalFail, users }) {
        const total = totalPass + totalFail || 1; // Evitar división por cero
        const passPercent = ((totalPass / total) * 100).toFixed(2);
        const failPercent = ((totalFail / total) * 100).toFixed(2);

        // Actualizamos las cajas principales
        document.getElementById('totalPass').textContent = `${totalPass}`;
        document.getElementById('totalFail').textContent = `${totalFail}`;

        // Actualizamos las barras horizontales
        document.getElementById('passLabel').textContent = `PASS: ${passPercent}%`;
        document.getElementById('failLabel').textContent = `FAIL: ${failPercent}%`;
        document.getElementById('passBar').style.width = passPercent + '%';
        document.getElementById('failBar').style.width = failPercent + '%';

        // Ordenamos usuarios por score para la tabla
        const sortedUsers = Object.entries(users)
        .sort(([, a], [, b]) => {
          const sumA = a.pass + a.failLow + a.failMedium + a.failHigh + a.failCritical;
          const sumB = b.pass + b.failLow + b.failMedium + b.failHigh + b.failCritical;
          return sumB - sumA;});

        // Rellenamos la tabla
        const tbody = document.querySelector('#userClassification tbody');
        tbody.innerHTML = sortedUsers.map(([user, data]) => `
          <tr>
            <td class="td2">${user}</td>
            <td>${data.pass}</td>
            <td>${data.failLow}</td>
            <td>${data.failMedium}</td>
            <td>${data.failHigh}</td>
            <td>${data.failCritical}</td>
          </tr>
        `).join('');
      }

      function updateCharts(data) {
        const users = Object.keys(data.users);
        const languages= Object.keys(data.languages)
        const userScores = users.map(user => data.users[user].score);
        const maxLang = Math.max(
          ...Object.values(data.languages).map(lang => Math.max(lang.pass, lang.fail))
        );
        // User Score Chart
        updateOrCreateChart('LanguageScoreChart', {
          type: 'bar',
          data: {
            labels: languages,
            datasets: [
              {
                label: 'PASS',
                data: languages.map(lang => data.languages[lang].pass),
                backgroundColor: '#75b798'
              },
              {
                label: 'FAIL',
                data: languages.map(lang => data.languages[lang].fail),
                backgroundColor: '#e35d6a'
              }
            ]
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true }
            },
            scales: {
              y: { beginAtZero: true, max: maxLang+2 }
            }
          }
        });
        
        // Pass/Fail Chart
        updateOrCreateChart('userPassFailChart', {
          type: 'bar',
          data: {
            labels: users,
            datasets: [
              {
                label: 'PASS',
                data: users.map(user => data.users[user].pass),
                backgroundColor: '#75b798'
              },
              {
                label: 'FAIL',
                data: users.map(user => 
                  data.users[user].failLow + 
                  data.users[user].failMedium + 
                  data.users[user].failHigh + 
                  data.users[user].failCritical
                ),
                backgroundColor: '#e35d6a'
              }
            ]
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true, max: maxModelValue+2 }
            }
          }
        });

        // Models per User Chart
        const allModels = [...new Set(
          Object.values(data.users)
            .flatMap(user => Object.keys(user.models))
        )];
        
        // Calculate maximum value among all model counts
        const maxModelValue = Math.max(
          ...allModels.map(model => Math.max(...users.map(user => data.users[user].models[model] || 0))),
          1
        );

        updateOrCreateChart('userModelChart', {
          type: 'bar',
          data: {
            labels: users,
            datasets: allModels.map(model => ({
              label: model,
              data: users.map(user => data.users[user].models[model] || 0),
              backgroundColor: MODEL_COLORS[model.toLowerCase()] || MODEL_COLORS.default
            }))
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true, max: maxModelValue+2}
            }
          }
        });

        // Categories Chart
        const categories = Object.keys(data.categories);
        const maxValue = Math.max(
          ...Object.values(data.categories).map(cat => Math.max(cat.pass, cat.fail))
        );

        updateOrCreateChart('categoriesChart', {
          type: 'bar',
          data: {
            labels: categories,
            datasets: [
              {
                label: 'PASS',
                data: categories.map(cat => data.categories[cat].pass),
                backgroundColor: '#75b798'
              },
              {
                label: 'FAIL',
                data: categories.map(cat => data.categories[cat].fail),
                backgroundColor: '#e35d6a'
              }
            ]
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { 
                beginAtZero: true,
                max: maxValue+2
              }
            }
          }
        });
      }

      function updateOrCreateChart(id, config) {
        if (charts[id]) {
          charts[id].destroy();
        }
        charts[id] = new Chart(document.getElementById(id), config);
      }

      async function refreshData() {
        try {
          const response = await fetch("https://script.google.com/a/macros/mondragon.edu/s/AKfycbwmjfrXu08q-jzHROM99LUV6hO7egw4Dr6zAzWihd-OTZfS9LkmQc9TEEBu4DOqBhMTqw/exec?getData=true");
          const rawData = await response.json();

          if(rawData.error) throw new Error(rawData.error);

          const processed = processData(rawData);
          updateUI(processed);
          updateCharts(processed);

        } catch(error) {
          console.error('Error:', error);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        refreshData();
        setInterval(refreshData, 1000);
      });
    </script>
  </body>
</html>
