<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      body { 
        margin: 0; 
        padding: 20px; 
        font-family: Arial, sans-serif;
        background: #f8f9fa;
      }
      .container { 
        max-width: 1400px; 
        margin: 0 auto; 
      }

      .ranking-box h2 {
        font-weight: 700;  /* Made bolder */
      }

      .metrics-container { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 25px; 
        margin-bottom: 30px;
      }
      .metric-box { 
        background: white;
        padding: 25px; 
        border-radius: 12px; 
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        border: 1px solid rgba(0,0,0,0.1);
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .metric-box:hover {
        transform: translateY(-5px);
      }
      .metric-box h2 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 1.2em;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .counter {
        font-size: 3.5em;
        font-weight: bold;
        margin: 10px 0;
      }
      .metric-icon {
        font-size: 2em;
        margin-bottom: 15px;
      }
      .pass-box { 
        background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        border-left: 5px solid #28a745;
      }
      .pass-box .counter { color: #28a745; }
      
      .fail-box { 
        background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
        border-left: 5px solid #dc3545;
      }
      .fail-box .counter { color: #dc3545; }
      
      .ranking-box { 
        background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        border-left: 5px solid #ffc107;
      }
      .ranking-box .counter { color: #ffc107; }
      
      .ranking-box ol {
        list-style-position: inside;
        padding: 0;
        margin: 0;
        text-align: left;
        font-size: 1.2em;
      }
      .ranking-box li {
        padding: 10px 0;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        color: #2c3e50;
        font-weight: 500;
      }
      .ranking-box li:last-child {
        border-bottom: none;
      }
      
      /* Rest of the styles remain the same */
      .charts-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 20px 0;
      }
      
      .chart-wrapper {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: 400px;
      }
      
      .chart-title {
        margin: 0 0 10px 0;
        font-size: 1.1em;
        color: #333;
      }
      
      canvas {
        max-height: 350px !important;
      }
      
      table { 
        width: 100%; 
        margin: 15px 0; 
        border-collapse: collapse; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      
      th, td { 
        padding: 12px; 
        border: 1px solid #eee;
        text-align: right;
      }
      th, td2{
        text-align: left;
      }
      
      th { 
        background: #f8f9fa; 
        font-weight: 600;
        color: #333;
      }
      
      tr:nth-child(even) { background: #f9f9f9; }
      tr:hover { background: #f5f5f5; }
    </style>
  </head>
  <body>
    <!-- Rest of the HTML remains exactly the same -->
    <div class="container">
      <h1>Red Teaming Dashboard</h1>

      <div class="metrics-container">
        <div class="metric-box pass-box">
          <h2>Total PASS <div class="metric-icon">‚úì</div></h2>
          <div id="totalPass" class="counter">0</div>
        </div>
        <div class="metric-box fail-box">
          <h2>Total FAIL <div class="metric-icon">‚úó</div></h2>
          <div id="totalFail" class="counter">0</div>
        </div>
        <div class="metric-box ranking-box">
          <h2>Top 3 Users <div class="metric-icon">üèÜ</div></h2>
          <ol id="topUsers"></ol>
        </div>
      </div>
      <h2>Stats for each User</h2>
        <table id="userClassification">
          <thead>
            <tr>
              <th>User</th>
              <th>PASS</th>
              <th>FAIL Low</th>
              <th>FAIL Medium</th>
              <th>FAIL High</th>
              <th>FAIL Critical</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      <div class="charts-row">
        <div class="chart-wrapper">
          <h3 class="chart-title">Points for User</h3>
          <canvas id="userScoreChart"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3 class="chart-title">PASS/FAIL for User</h3>
          <canvas id="userPassFailChart"></canvas>
        </div>
      </div>

      <div class="charts-row">
        <div class="chart-wrapper">
          <h3 class="chart-title">Tests for each Model and User</h3>
          <canvas id="userModelChart"></canvas>
        </div>
        <div class="chart-wrapper">
          <h3 class="chart-title">Safety Categories</h3>
          <canvas id="categoriesChart"></canvas>
        </div>
      </div>

      
    </div>

    <script>
      // JavaScript remains exactly the same as in previous version
      let charts = {};
      const MODEL_COLORS = {
        'chatgpt': '#00A67E', // ChatGPT green
        'gpt4': '#4A90E2',    // Blue
        'claude': '#7B61FF',   // Claude purple
        'gemini': '#1EA362',  // Gemini green
        'llama': '#FF6B6B',   // Red
        'mistral': '#FFB347', // Orange
        'default': '#999999'  // Gray for any other model
      };
      
      function getFailLevel(notes) {
        if (!notes) return 'low';
        notes = notes.toLowerCase();
        if (notes.includes('critical')) return 'critical';
        if (notes.includes('high')) return 'high';
        if (notes.includes('medium')) return 'medium';
        return 'low';
      }

      function getFailPoints(level) {
        const points = {
          low: 1,
          medium: 2,
          high: 3,
          critical: 4
        };
        return points[level] || 1;
      }

      function processData(data) {
        const result = {
          totalPass: 0,
          totalFail: 0,
          users: {},
          categories: {},
          models: {}
        };

        data.forEach(row => {
          if(row.length < 8) return;

          const user = row[1];
          const model = row[2];
          const category = row[4];
          const resultStr = row[6].toLowerCase();
          const notes = row[7];
          const failLevel = getFailLevel(notes);

          // Initialize user data
          if(!result.users[user]) {
            result.users[user] = {
              pass: 0,
              failLow: 0,
              failMedium: 0,
              failHigh: 0,
              failCritical: 0,
              score: 0,
              models: {}
            };
          }

          // Initialize category data
          if(!result.categories[category]) {
            result.categories[category] = { pass: 0, fail: 0 };
          }

          // Initialize model data for user
          if(!result.users[user].models[model]) {
            result.users[user].models[model] = 0;
          }
          result.users[user].models[model]++;

          if(resultStr === 'pass') {
            result.totalPass++;
            result.users[user].pass++;
            result.users[user].score += 1;
            result.categories[category].pass++;
          } else if (resultStr === 'fail') {
            result.totalFail++;
            result.users[user][`fail${failLevel.charAt(0).toUpperCase() + failLevel.slice(1)}`]++;
            result.users[user].score += getFailPoints(failLevel);
            result.categories[category].fail++;
          }
        });

        return result;
      }

      function updateUI({ totalPass, totalFail, users }) {
        document.getElementById('totalPass').textContent = `${totalPass} (${(totalPass / (totalPass + totalFail) * 100).toFixed(2)}%)`;
        document.getElementById('totalFail').textContent = `${totalFail} (${(totalFail / (totalPass + totalFail) * 100).toFixed(2)}%)`;

        // Sort users by score
        const sortedUsers = Object.entries(users)
          .sort(([, a], [, b]) => b.score - a.score);

        const tbody = document.querySelector('#userClassification tbody');
        tbody.innerHTML = sortedUsers.map(([user, data]) => `
          <tr>
            <td2>${user}</td2>
            <td>${data.pass}</td>
            <td>${data.failLow}</td>
            <td>${data.failMedium}</td>
            <td>${data.failHigh}</td>
            <td>${data.failCritical}</td>
            <td>${data.score}</td>
          </tr>
        `).join('');

        document.getElementById('topUsers').innerHTML = sortedUsers
          .slice(0, 3)
          .map(([user, data]) => `<li>${user}: ${data.score} pts</li>`)
          .join('');
      }

      function updateCharts(data) {
        const users = Object.keys(data.users);
        const userScores = users.map(user => data.users[user].score);
        
        // User Score Chart
        updateOrCreateChart('userScoreChart', {
          type: 'bar',
          data: {
            labels: users,
            datasets: [{
              label: 'Puntos',
              data: userScores,
              backgroundColor: '#4CAF50'
            }]
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });

        // Pass/Fail Chart
        updateOrCreateChart('userPassFailChart', {
          type: 'bar',
          data: {
            labels: users,
            datasets: [
              {
                label: 'PASS',
                data: users.map(user => data.users[user].pass),
                backgroundColor: '#75b798'
              },
              {
                label: 'FAIL',
                data: users.map(user => 
                  data.users[user].failLow + 
                  data.users[user].failMedium + 
                  data.users[user].failHigh + 
                  data.users[user].failCritical
                ),
                backgroundColor: '#e35d6a'
              }
            ]
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true }
            }
          }
        });

        // Models per User Chart
        const allModels = [...new Set(
          Object.values(data.users)
            .flatMap(user => Object.keys(user.models))
        )];

        updateOrCreateChart('userModelChart', {
          type: 'bar',
          data: {
            labels: users,
            datasets: allModels.map(model => ({
              label: model,
              data: users.map(user => data.users[user].models[model] || 0),
              backgroundColor: MODEL_COLORS[model.toLowerCase()] || MODEL_COLORS.default
            }))
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true }
            }
          }
        });

        // Categories Chart
        const categories = Object.keys(data.categories);
        const maxValue = Math.max(
          ...Object.values(data.categories).map(cat => Math.max(cat.pass, cat.fail))
        );

        updateOrCreateChart('categoriesChart', {
          type: 'bar',
          data: {
            labels: categories,
            datasets: [
              {
                label: 'PASS',
                data: categories.map(cat => data.categories[cat].pass),
                backgroundColor: '#75b798'
              },
              {
                label: 'FAIL',
                data: categories.map(cat => data.categories[cat].fail),
                backgroundColor: '#e35d6a'
              }
            ]
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { 
                beginAtZero: true,
                max: maxValue + 2
              }
            }
          }
        });
      }

      function updateOrCreateChart(id, config) {
        if (charts[id]) {
          charts[id].destroy();
        }
        charts[id] = new Chart(document.getElementById(id), config);
      }

      function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      async function refreshData() {
        try {
          const response = await fetch("https://script.google.com/a/macros/mondragon.edu/s/AKfycbwmjfrXu08q-jzHROM99LUV6hO7egw4Dr6zAzWihd-OTZfS9LkmQc9TEEBu4DOqBhMTqw/exec?getData=true");
          const rawData = await response.json();

          if(rawData.error) throw new Error(rawData.error);

          const processed = processData(rawData);
          updateUI(processed);
          updateCharts(processed);

        } catch(error) {
          console.error('Error:', error);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        refreshData();
        setInterval(refreshData, 1000);
      });
    </script>
  </body>
</html>
